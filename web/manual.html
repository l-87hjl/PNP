<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Lock Builder - P vs NP</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üõ†Ô∏è Manual Lock Builder</h1>
            <p class="subtitle">Create custom lock instances with visual feedback</p>
            <a href="index.html" class="btn btn-secondary" style="margin-top: 15px;">‚Üê Back to Home</a>
        </header>

        <!-- Builder Interface -->
        <div class="builder-container">
            <!-- Left Panel: Controls -->
            <div class="control-panel">
                <!-- Initialize Lock -->
                <div class="control-section">
                    <h3>Initialize Lock</h3>
                    <div class="form-group">
                        <label for="numDials">Number of Dials:</label>
                        <input type="number" id="numDials" min="1" max="20" value="3" />
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="createLock()">Create Lock</button>
                    <div id="initMessage"></div>
                </div>

                <!-- Add Negation Link -->
                <div class="control-section">
                    <h3>Add Negation Link</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                        Constraint: dial<sub>i</sub> + dial<sub>j</sub> = 7
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="negDial1">Dial i:</label>
                            <select id="negDial1"></select>
                        </div>
                        <div class="form-group">
                            <label for="negDial2">Dial j:</label>
                            <select id="negDial2"></select>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="addNegation()">Add Negation</button>
                    <div id="negMessage"></div>
                </div>

                <!-- Add OR Clause -->
                <div class="control-section">
                    <h3>Add OR Clause</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">
                        Constraint: dial<sub>i</sub> + dial<sub>j</sub> + dial<sub>k</sub> ‚â• 8
                    </p>
                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="clauseDial1">Dial i:</label>
                            <select id="clauseDial1"></select>
                        </div>
                        <div class="form-group">
                            <label for="clauseDial2">Dial j:</label>
                            <select id="clauseDial2"></select>
                        </div>
                        <div class="form-group">
                            <label for="clauseDial3">Dial k:</label>
                            <select id="clauseDial3"></select>
                        </div>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="addClause()">Add Clause</button>
                    <div id="clauseMessage"></div>
                </div>

                <!-- Constraint List -->
                <div class="control-section">
                    <h3>Constraints</h3>
                    <div id="constraintsList" class="constraint-list-box">
                        <p style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 20px 0;">
                            No constraints added yet
                        </p>
                    </div>
                </div>

                <!-- Download -->
                <div class="control-section" style="border-bottom: none;">
                    <button class="btn btn-primary" style="width: 100%; background-color: var(--accent-green);" onclick="downloadJSON()">
                        üíæ Download Lock JSON
                    </button>
                </div>
            </div>

            <!-- Right Panel: Visualization -->
            <div class="visualization-panel">
                <h3>Lock Visualization</h3>
                <canvas id="lockCanvas" width="700" height="600"></canvas>

                <!-- Legend -->
                <div class="legend">
                    <h4>Legend:</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #58a6ff; width: 30px; height: 30px; border-radius: 50%;"></div>
                        <span>Dial (numbered)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f85149;"></div>
                        <span>Negation Link (dial<sub>i</sub> + dial<sub>j</sub> = 7)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3fb950;"></div>
                        <span>OR Clause (dial<sub>i</sub> + dial<sub>j</sub> + dial<sub>k</sub> ‚â• 8)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Lock Builder JavaScript
        // ============================================

        // Global state
        let lockState = {
            numDials: 0,
            binaryPins: [],
            negations: [],
            clauses: []
        };

        let dialPositions = []; // Store dial positions for visualization

        // Canvas setup
        const canvas = document.getElementById('lockCanvas');
        const ctx = canvas.getContext('2d');

        /**
         * Initialize the lock with specified number of dials
         */
        function createLock() {
            const numDials = parseInt(document.getElementById('numDials').value);
            const msgDiv = document.getElementById('initMessage');

            // Validate input
            if (isNaN(numDials) || numDials < 1 || numDials > 20) {
                showMessage(msgDiv, 'Please enter a number between 1 and 20', 'error');
                return;
            }

            // Reset state
            lockState = {
                numDials: numDials,
                binaryPins: Array.from({length: numDials}, (_, i) => i + 1),
                negations: [],
                clauses: []
            };

            // Update dropdowns
            updateDropdowns();

            // Clear constraint list
            updateConstraintsList();

            // Visualize
            visualizeLock();

            showMessage(msgDiv, `Lock created with ${numDials} dials (all binary-pinned)`, 'success');
        }

        /**
         * Update dropdown options based on current number of dials
         */
        function updateDropdowns() {
            const dialOptions = Array.from({length: lockState.numDials}, (_, i) =>
                `<option value="${i + 1}">Dial ${i + 1}</option>`
            ).join('');

            document.getElementById('negDial1').innerHTML = dialOptions;
            document.getElementById('negDial2').innerHTML = dialOptions;
            document.getElementById('clauseDial1').innerHTML = dialOptions;
            document.getElementById('clauseDial2').innerHTML = dialOptions;
            document.getElementById('clauseDial3').innerHTML = dialOptions;
        }

        /**
         * Add a negation link
         */
        function addNegation() {
            const msgDiv = document.getElementById('negMessage');

            if (lockState.numDials === 0) {
                showMessage(msgDiv, 'Please create a lock first', 'error');
                return;
            }

            const dial1 = parseInt(document.getElementById('negDial1').value);
            const dial2 = parseInt(document.getElementById('negDial2').value);

            // Validate
            if (dial1 === dial2) {
                showMessage(msgDiv, 'Dials must be different', 'error');
                return;
            }

            // Check for duplicate (in either order)
            const isDuplicate = lockState.negations.some(neg =>
                (neg[0] === dial1 && neg[1] === dial2) ||
                (neg[0] === dial2 && neg[1] === dial1)
            );

            if (isDuplicate) {
                showMessage(msgDiv, 'This negation already exists', 'error');
                return;
            }

            // Add negation
            lockState.negations.push([dial1, dial2]);
            updateConstraintsList();
            visualizeLock();
            showMessage(msgDiv, `Added Not(${dial1}, ${dial2})`, 'success');
        }

        /**
         * Add an OR clause
         */
        function addClause() {
            const msgDiv = document.getElementById('clauseMessage');

            if (lockState.numDials === 0) {
                showMessage(msgDiv, 'Please create a lock first', 'error');
                return;
            }

            const dial1 = parseInt(document.getElementById('clauseDial1').value);
            const dial2 = parseInt(document.getElementById('clauseDial2').value);
            const dial3 = parseInt(document.getElementById('clauseDial3').value);

            // Validate distinct dials
            const dials = [dial1, dial2, dial3];
            if (new Set(dials).size !== 3) {
                showMessage(msgDiv, 'All three dials must be different', 'error');
                return;
            }

            // Check for duplicate
            const isDuplicate = lockState.clauses.some(clause => {
                const clauseSet = new Set(clause);
                return dials.every(d => clauseSet.has(d));
            });

            if (isDuplicate) {
                showMessage(msgDiv, 'This clause already exists', 'error');
                return;
            }

            // Add clause
            lockState.clauses.push([dial1, dial2, dial3]);
            updateConstraintsList();
            visualizeLock();
            showMessage(msgDiv, `Added OR(${dial1}, ${dial2}, ${dial3})`, 'success');
        }

        /**
         * Remove a constraint
         */
        function removeConstraint(type, index) {
            if (type === 'negation') {
                lockState.negations.splice(index, 1);
            } else if (type === 'clause') {
                lockState.clauses.splice(index, 1);
            }
            updateConstraintsList();
            visualizeLock();
        }

        /**
         * Update the constraints list display
         */
        function updateConstraintsList() {
            const listDiv = document.getElementById('constraintsList');

            if (lockState.negations.length === 0 && lockState.clauses.length === 0) {
                listDiv.innerHTML = `
                    <p style="color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 20px 0;">
                        No constraints added yet
                    </p>
                `;
                return;
            }

            let html = '';

            // Add negations
            lockState.negations.forEach((neg, index) => {
                html += `
                    <div class="constraint-item">
                        <span>Not(${neg[0]}, ${neg[1]})</span>
                        <button class="remove-btn" onclick="removeConstraint('negation', ${index})">Remove</button>
                    </div>
                `;
            });

            // Add clauses
            lockState.clauses.forEach((clause, index) => {
                html += `
                    <div class="constraint-item">
                        <span>OR(${clause[0]}, ${clause[1]}, ${clause[2]})</span>
                        <button class="remove-btn" onclick="removeConstraint('clause', ${index})">Remove</button>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        /**
         * Visualize the lock on canvas
         */
        function visualizeLock() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (lockState.numDials === 0) {
                ctx.fillStyle = '#8b949e';
                ctx.font = '18px var(--font-sans)';
                ctx.textAlign = 'center';
                ctx.fillText('Create a lock to see visualization', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Calculate dial positions in a circle
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;

            dialPositions = [];
            for (let i = 0; i < lockState.numDials; i++) {
                const angle = (i / lockState.numDials) * 2 * Math.PI - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                dialPositions.push({x, y, number: i + 1});
            }

            // Draw negations (red lines)
            ctx.strokeStyle = '#f85149';
            ctx.lineWidth = 3;
            lockState.negations.forEach(neg => {
                const pos1 = dialPositions[neg[0] - 1];
                const pos2 = dialPositions[neg[1] - 1];
                ctx.beginPath();
                ctx.moveTo(pos1.x, pos1.y);
                ctx.lineTo(pos2.x, pos2.y);
                ctx.stroke();
            });

            // Draw clauses (green triangles)
            ctx.strokeStyle = '#3fb950';
            ctx.lineWidth = 2;
            ctx.fillStyle = 'rgba(63, 185, 80, 0.1)';
            lockState.clauses.forEach(clause => {
                const pos1 = dialPositions[clause[0] - 1];
                const pos2 = dialPositions[clause[1] - 1];
                const pos3 = dialPositions[clause[2] - 1];

                ctx.beginPath();
                ctx.moveTo(pos1.x, pos1.y);
                ctx.lineTo(pos2.x, pos2.y);
                ctx.lineTo(pos3.x, pos3.y);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            });

            // Draw dials (blue circles)
            dialPositions.forEach(pos => {
                // Circle
                ctx.fillStyle = '#58a6ff';
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 25, 0, 2 * Math.PI);
                ctx.fill();

                // Number
                ctx.fillStyle = '#0d1117';
                ctx.font = 'bold 16px var(--font-sans)';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(pos.number, pos.x, pos.y);
            });
        }

        /**
         * Download lock instance as JSON
         */
        function downloadJSON() {
            if (lockState.numDials === 0) {
                alert('Please create a lock first');
                return;
            }

            // Build JSON object
            const lockJSON = {
                num_dials: lockState.numDials,
                binary_pins: lockState.binaryPins,
                negations: lockState.negations,
                clauses: lockState.clauses
            };

            // Create blob and download
            const blob = new Blob([JSON.stringify(lockJSON, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lock_instance_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Show a message to the user
         */
        function showMessage(element, message, type) {
            const className = type === 'error' ? 'error-message' : 'success-message';
            element.innerHTML = `<div class="${className}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        // Initialize empty visualization on load
        window.onload = function() {
            visualizeLock();
        };
    </script>
</body>
</html>
